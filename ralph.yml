cli:
  backend: "claude"

event_loop:
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 50
  prompt_file: "PROMPT.md"
  starting_event: "work.start"
  checkpoint_interval: 1

core:
  scratchpad: ".agent/scratchpad.md"
  specs_dir: "./specs/"

hats:
  git_setup:
    name: "Git Setup"
    description: |
      Git/GitHub初期化。失敗したら即LOOP_COMPLETE。

      実行手順:
      1. gh auth status (認証確認、失敗→LOOP_COMPLETE)
      2. git status で状態確認
      3. 変更があれば git add -A && git commit -m "[Ralph] Session start"
      4. git push origin main

      全て成功 → git.ready / いずれか失敗 → LOOP_COMPLETE

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "work.start"
    publishes:
      - "git.ready"
      - "LOOP_COMPLETE"

  architect:
    name: "Architect"
    description: |
      システム設計・API仕様策定。

      my-usagi固有の設計ポイント:
      - 子ども向けUI: シンプル、大きなボタン、音声中心
      - Cloudflare Workers + Durable Objects でセッション管理
      - D1: 会話ログ・語彙データ
      - R2: 音声ファイル（raw + TTSキャッシュ）
      - Queues: 非同期解析

      成果物:
      - specs/api.md: エンドポイント定義
      - specs/data-model.md: D1スキーマ
      - specs/conversation-flow.md: 会話フロー

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "git.ready"
    publishes:
      - "specs.ready.backend"
      - "specs.ready.frontend"

  backend:
    name: "Backend Developer"
    description: |
      Cloudflare Workers バックエンド実装。

      実装対象 (src/):
      - index.ts: メインワーカー、ルーティング
      - Durable Objects: 会話セッション管理
      - D1操作: 会話ログ保存・取得
      - R2操作: 音声ファイル保存・取得
      - Queues: 非同期解析ジョブ
      - Cron: 日次サマリ生成

      安全性:
      - 3歳向けLLM直結のリスク考慮
      - プロンプトインジェクション対策
      - 音声データのプライバシー保護

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "specs.ready.backend"
      - "review.backend.changes"
    publishes:
      - "backend.done"

  frontend:
    name: "Frontend Developer"
    description: |
      PWA フロントエンド実装。

      実装対象 (public/):
      - 子ども向けUI (index.html, app.js, style.css)
        - ウサギキャラクター表示
        - 音声入力（MediaRecorder + サーバASR）
        - 音声出力（TTS再生）
        - シンプルで直感的な操作
      - 親向けダッシュボード (parent/)
        - 会話ログ閲覧
        - 語彙発達グラフ
        - ハイライト表示
      - Service Worker (sw.js)
      - Manifest (manifest.webmanifest)

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "specs.ready.frontend"
      - "review.frontend.changes"
    publishes:
      - "frontend.done"

  integrator:
    name: "Integrator"
    description: |
      統合テスト・最終確認。

      確認項目:
      - 子どもUI ↔ Workers API 疎通
      - 音声録音 → ASR → LLM → TTS の一連フロー
      - D1/R2 データ永続化
      - 親ダッシュボードからのログ閲覧
      - PWA オフライン動作
      - wrangler dev でのローカル動作確認

      問題発見時:
      - backend問題 → review.backend.changes
      - frontend問題 → review.frontend.changes

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push

      LOOP_COMPLETE発行時は追加で:
      3. COMPLETION_REPORT.md を生成
      4. 最終 git push
    triggers:
      - "backend.done"
      - "frontend.done"
    publishes:
      - "review.backend.changes"
      - "review.frontend.changes"
      - "LOOP_COMPLETE"
